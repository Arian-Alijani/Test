name: List Available Runners

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  actions: read
  contents: read

jobs:
  list-runners:
    runs-on: ubuntu-latest
    steps:
      - name: Repo context
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "repo=${GITHUB_REPOSITORY}"
          echo "owner=${GITHUB_REPOSITORY_OWNER}"
          echo "actor=${GITHUB_ACTOR}"
          echo "run_id=${GITHUB_RUN_ID}"

      - name: Fetch repository runners
        id: repo_runners
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -Eeuo pipefail
          API_URL="https://api.github.com/repos/${REPO}/actions/runners?per_page=100"
          HTTP_CODE="$(curl -sS -w "%{http_code}" -o repo-runners.json \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL")"

          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "Failed to fetch repo runners. HTTP=$HTTP_CODE"
            cat repo-runners.json
            exit 1
          fi

          TOTAL="$(jq -r '.total_count // 0' repo-runners.json)"
          echo "total_repo_runners=$TOTAL" >> "$GITHUB_OUTPUT"

      - name: Print repository runners in logs
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "=== Repository Runners ==="
          jq -r '
            if (.runners | length) == 0 then
              "No runners visible at repository level."
            else
              .runners[]
              | "- name=\(.name) status=\(.status) busy=\(.busy) labels=[\(.labels | map(.name) | join(","))]"
            end
          ' repo-runners.json

      - name: Try organization runners (best effort)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          ORG: ${{ github.repository_owner }}
        run: |
          set -Eeuo pipefail
          API_URL="https://api.github.com/orgs/${ORG}/actions/runners?per_page=100"
          HTTP_CODE="$(curl -sS -w "%{http_code}" -o org-runners.json \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL" || true)"

          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "Cannot read org runners (likely permission scope). HTTP=$HTTP_CODE"
            echo "{\"note\":\"org runner listing unavailable\",\"http_code\":\"$HTTP_CODE\"}" > org-runners.json
            exit 0
          fi

          echo "=== Organization Runners ==="
          jq -r '
            if (.runners | length) == 0 then
              "No org runners visible."
            else
              .runners[]
              | "- name=\(.name) status=\(.status) busy=\(.busy) labels=[\(.labels | map(.name) | join(","))]"
            end
          ' org-runners.json

      - name: Build summary
        shell: bash
        run: |
          set -Eeuo pipefail
          {
            echo "## Runner Inventory"
            echo
            echo "Repository: \`${GITHUB_REPOSITORY}\`"
            echo "Run ID: \`${GITHUB_RUN_ID}\`"
            echo
            echo "### Repository Runners"
            jq -r '
              if (.runners | length) == 0 then
                "- No runners visible."
              else
                .runners[]
                | "- \(.name) | status=\(.status) | busy=\(.busy) | labels=\(.labels | map(.name) | join(","))"
              end
            ' repo-runners.json
            echo
            echo "### Organization Runners (best effort)"
            jq -r '
              if has("runners") then
                if (.runners | length) == 0 then
                  "- No org runners visible."
                else
                  .runners[]
                  | "- \(.name) | status=\(.status) | busy=\(.busy) | labels=\(.labels | map(.name) | join(","))"
                end
              else
                "- Unavailable: insufficient permission or not an org repository."
              end
            ' org-runners.json
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload runner reports
        uses: actions/upload-artifact@v4
        with:
          name: runner-inventory
          path: |
            repo-runners.json
            org-runners.json
